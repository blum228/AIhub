---
import { getCollection } from 'astro:content';
import SiteLayout from '../layouts/SiteLayout.astro';
import Wrapper from '../components/Wrapper.astro';
import Space from '../components/Space.astro';
import CatalogFAQ from '../components/CatalogFAQ.astro';
import { url } from '../utils/url';

const allModels = await getCollection('models');

const models = allModels
  .map(entry => ({ 
    slug: entry.id.replace('.yaml', ''), 
    name: entry.data.name,
    rating: entry.data.rating,
    pricing: entry.data.pricing,
    priceFrom: entry.data.priceFrom,
    tagline: entry.data.tagline,
    description: entry.data.description,
    logo: entry.data.logo,
    status: entry.data.status || 'active',
    features: entry.data.features || {},
    advancedFeatures: entry.data.advancedFeatures || {},
    paymentMethods: entry.data.payment_methods || [],
    platforms: entry.data.platforms || ['web'],
    vpnRequired: entry.data.vpn_required ?? true,
  }))
  .filter(m => m.status === 'active')
  .sort((a, b) => b.rating - a.rating);

const filterConfig = [
  { id: 'payment', label: '–¶–µ–Ω–∞', options: [
    { value: 'free', label: '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' },
    { value: 'mir', label: '–ö–∞—Ä—Ç–∞ –†–§' },
    { value: 'crypto', label: '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞' },
  ]},
  { id: 'platform', label: '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞', options: [
    { value: 'web', label: 'Web' },
    { value: 'ios', label: 'iOS' },
    { value: 'android', label: 'Android' },
    { value: 'telegram', label: 'Telegram' },
  ]},
  { id: 'features', label: '–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏', options: [
    { value: 'russian', label: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫' },
    { value: 'voice', label: '–ì–æ–ª–æ—Å' },
    { value: 'image-gen', label: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ' },
    { value: 'memory', label: '–ü–∞–º—è—Ç—å' },
    { value: 'no-vpn', label: '–ë–µ–∑ VPN' },
  ]},
  { id: 'meaning', label: '–¢–∏–ø', options: [
    { value: 'nsfw', label: 'NSFW' },
    { value: 'roleplay', label: '–†–æ–ª–µ–ø–ª–µ–π' },
  ]},
];
---

<SiteLayout 
  title="–ö–∞—Ç–∞–ª–æ–≥ AI-–¥–µ–≤—É—à–µ–∫ 2025 ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, —Ä–µ–π—Ç–∏–Ω–≥–∏ | AIGirlsHub"
  description="–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ AI-–¥–µ–≤—É—à–µ–∫. –§–∏–ª—å—Ç—Ä—ã –ø–æ –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–æ–π –†–§, –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ, —è–∑—ã–∫—É."
>
  <Wrapper>
    <Space size="S" />

    <div class="filters">
      <div class="filters__row">
        <span class="filters__label">–§–∏–ª—å—Ç—Ä:</span>
        {filterConfig.map(group => (
          <div class="dropdown" data-group={group.id}>
            <button class="dropdown__trigger" type="button">
              {group.label}
              <span class="dropdown__badge" data-badge={group.id}>0</span>
              <svg class="dropdown__arrow" width="10" height="6" viewBox="0 0 10 6" fill="none">
                <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </button>
            <div class="dropdown__menu">
              {group.options.map(opt => (
                <label class="dropdown__option">
                  <input type="checkbox" data-filter={group.id} value={opt.value} class="dropdown__checkbox" />
                  <span class="dropdown__text">{opt.label}</span>
                  <span class="dropdown__count" data-count={`${group.id}:${opt.value}`}></span>
                </label>
              ))}
            </div>
          </div>
        ))}
        <span class="filters__count"><span id="results-count">0</span> —Å–µ—Ä–≤–∏—Å–æ–≤</span>
      </div>
      <div class="filters__tags" id="active-tags"></div>
    </div>

    <Space size="L" />
    <div class="grid" id="catalog-grid"></div>
    <div class="catalog-empty" id="empty-state">
      <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
      <button type="button" id="reset-filters">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>
    <Space size="L" />

    <div class="catalog-actions">
      <a href={url('/compare')} class="action-link">–°—Ä–∞–≤–Ω–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã ‚Üí</a>
    </div>
    <Space size="XL" />
    <CatalogFAQ />
    <Space size="XL" />
  </Wrapper>

  <script is:inline define:vars={{ models, filterConfig, baseUrl: import.meta.env.BASE_URL || '' }}>
    window.__CATALOG_DATA__ = models;
    window.__FILTER_CONFIG__ = filterConfig;
    window.__BASE_URL__ = baseUrl;
  </script>
</SiteLayout>

<script is:inline>
(function() {
  var models = window.__CATALOG_DATA__;
  var filterConfig = window.__FILTER_CONFIG__;
  var baseUrl = window.__BASE_URL__ || '';
  var activeFilters = { payment: new Set(), platform: new Set(), features: new Set(), meaning: new Set() };

  var grid = document.getElementById('catalog-grid');
  var emptyState = document.getElementById('empty-state');
  var resultsCount = document.getElementById('results-count');
  var tagsContainer = document.getElementById('active-tags');

  function initFromURL() {
    var params = new URLSearchParams(window.location.search);
    params.forEach(function(value, key) {
      if (activeFilters[key]) {
        activeFilters[key].add(value);
        var cb = document.querySelector('input[data-filter="' + key + '"][value="' + value + '"]');
        if (cb) cb.checked = true;
      }
    });
  }

  function matchesFilters(m) {
    if (activeFilters.payment.has('free') && m.pricing !== 'free') return false;
    if (activeFilters.payment.has('mir') && !m.paymentMethods.includes('mir') && !m.paymentMethods.includes('sbp')) return false;
    if (activeFilters.payment.has('crypto') && !m.paymentMethods.includes('crypto')) return false;
    var platformArr = Array.from(activeFilters.platform);
    for (var i = 0; i < platformArr.length; i++) {
      if (!m.platforms.includes(platformArr[i])) return false;
    }
    if (activeFilters.features.has('russian') && !m.features.russian) return false;
    if (activeFilters.features.has('voice') && !m.features.voice) return false;
    if (activeFilters.features.has('image-gen') && !m.features.imageGen) return false;
    if (activeFilters.features.has('memory') && (!m.advancedFeatures || m.advancedFeatures.memoryType !== 'persistent')) return false;
    if (activeFilters.features.has('no-vpn') && m.vpnRequired) return false;
    if (activeFilters.meaning.has('nsfw') && !m.features.nsfw) return false;
    if (activeFilters.meaning.has('roleplay') && !m.features.roleplay) return false;
    return true;
  }

  function countFor(group, value) {
    var was = activeFilters[group].has(value);
    if (!was) activeFilters[group].add(value);
    var c = models.filter(matchesFilters).length;
    if (!was) activeFilters[group].delete(value);
    return c;
  }

  function updateCounts() {
    filterConfig.forEach(function(g) {
      var active = 0;
      g.options.forEach(function(o) {
        var el = document.querySelector('[data-count="' + g.id + ':' + o.value + '"]');
        if (el) el.textContent = '(' + countFor(g.id, o.value) + ')';
        if (activeFilters[g.id].has(o.value)) active++;
      });
      var badge = document.querySelector('[data-badge="' + g.id + '"]');
      if (badge) {
        badge.textContent = active;
        badge.style.display = active > 0 ? 'inline-flex' : 'none';
      }
    });
  }

  function renderCard(m) {
    var tags = [];
    if (m.pricing === 'free') tags.push('Free');
    if (m.features.russian) tags.push('RU');
    if (m.features.nsfw) tags.push('NSFW');
    if (m.features.voice) tags.push('Voice');
    if (m.features.imageGen) tags.push('Images');
    if (m.advancedFeatures && m.advancedFeatures.memoryType === 'persistent') tags.push('Memory');
    var hasRuPay = m.paymentMethods.includes('mir') || m.paymentMethods.includes('sbp');
    if (hasRuPay) tags.push('RU Pay');
    if (!m.vpnRequired) tags.push('No VPN');
    var t = tags.slice(0, 4);
    
    var tagsHtml = '';
    if (t.length) {
      var spans = t.map(function(x) {
        var c = 'tag';
        if (x === 'NSFW') c = 'tag tag--nsfw';
        else if (x === 'Free') c = 'tag tag--free';
        else if (x === 'RU' || x === 'RU Pay') c = 'tag tag--ru';
        return '<span class="' + c + '">' + x + '</span>';
      });
      tagsHtml = '<div class="card__tags">' + spans.join(' ') + '</div>';
    }
    
    var price = 'Freemium';
    if (m.pricing === 'free') price = '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ';
    else if (m.priceFrom) price = '–æ—Ç ' + m.priceFrom + ' —Ä—É–±';
    var priceCls = m.pricing === 'free' ? 'card__price card__price--free' : 'card__price';
    
    var preview = '';
    if (m.logo) {
      preview = '<img src="' + m.logo + '" alt="' + m.name + '" loading="lazy" class="card__img">';
    } else {
      preview = '<div class="card__placeholder"><span class="card__initial">' + m.name[0] + '</span></div>';
    }
    
    var badge = hasRuPay ? '<span class="card__badge">üá∑üá∫</span>' : '';
    var desc = m.tagline || m.description.slice(0, 80);
    
    return '<a href="' + baseUrl + '/models/' + m.slug + '" class="card">' +
      '<div class="card__preview">' + preview +
        '<div class="card__overlay">' +
          '<span class="card__rating">‚òÖ ' + m.rating.toFixed(1) + '</span>' + badge +
        '</div>' +
      '</div>' +
      '<div class="card__body">' +
        '<div class="card__header">' +
          '<h3 class="card__title">' + m.name + '</h3>' +
          '<span class="' + priceCls + '">' + price + '</span>' +
        '</div>' +
        '<p class="card__desc">' + desc + '</p>' +
        tagsHtml +
      '</div>' +
    '</a>';
  }

  function renderGrid() {
    var filtered = models.filter(matchesFilters);
    resultsCount.textContent = filtered.length;
    if (filtered.length === 0) {
      grid.style.display = 'none';
      emptyState.style.display = 'block';
    } else {
      grid.style.display = 'grid';
      emptyState.style.display = 'none';
      grid.innerHTML = filtered.map(renderCard).join('');
    }
    updateCounts();
    renderTags();
    updateURL();
  }

  function renderTags() {
    var html = [];
    filterConfig.forEach(function(g) {
      activeFilters[g.id].forEach(function(v) {
        var o = g.options.find(function(x) { return x.value === v; });
        if (o) html.push('<button class="active-tag" data-group="' + g.id + '" data-value="' + v + '">' + g.label + ': ' + o.label + ' <span class="active-tag__x">√ó</span></button>');
      });
    });
    if (html.length) {
      tagsContainer.innerHTML = html.join('') + '<button class="clear-all-btn" id="clear-all">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>';
      tagsContainer.style.display = 'flex';
      tagsContainer.querySelectorAll('.active-tag').forEach(function(b) {
        b.addEventListener('click', function() {
          var gr = b.getAttribute('data-group');
          var val = b.getAttribute('data-value');
          if (gr && val) {
            activeFilters[gr].delete(val);
            var cb = document.querySelector('input[data-filter="' + gr + '"][value="' + val + '"]');
            if (cb) cb.checked = false;
          }
          renderGrid();
        });
      });
      var clearBtn = document.getElementById('clear-all');
      if (clearBtn) clearBtn.addEventListener('click', clearAll);
    } else {
      tagsContainer.style.display = 'none';
      tagsContainer.innerHTML = '';
    }
  }

  function updateURL() {
    var p = new URLSearchParams();
    for (var g in activeFilters) {
      activeFilters[g].forEach(function(v) { p.append(g, v); });
    }
    history.replaceState(null, '', p.toString() ? baseUrl + '/catalog?' + p : baseUrl + '/catalog');
  }

  function clearAll() {
    for (var k in activeFilters) activeFilters[k].clear();
    document.querySelectorAll('.dropdown__checkbox').forEach(function(c) { c.checked = false; });
    renderGrid();
  }

  function initDropdowns() {
    document.querySelectorAll('.dropdown__trigger').forEach(function(t) {
      t.addEventListener('click', function(e) {
        e.stopPropagation();
        var d = e.target.closest('.dropdown');
        var was = d && d.classList.contains('is-open');
        document.querySelectorAll('.dropdown').forEach(function(x) { x.classList.remove('is-open'); });
        if (!was && d) d.classList.add('is-open');
      });
    });
    document.addEventListener('click', function() {
      document.querySelectorAll('.dropdown').forEach(function(x) { x.classList.remove('is-open'); });
    });
    document.querySelectorAll('.dropdown__menu').forEach(function(m) {
      m.addEventListener('click', function(e) { e.stopPropagation(); });
    });
    document.querySelectorAll('.dropdown__checkbox').forEach(function(c) {
      c.addEventListener('change', function(e) {
        var g = e.target.getAttribute('data-filter');
        var v = e.target.value;
        if (g) {
          if (e.target.checked) activeFilters[g].add(v);
          else activeFilters[g].delete(v);
        }
        renderGrid();
      });
    });
  }

  var resetBtn = document.getElementById('reset-filters');
  if (resetBtn) resetBtn.addEventListener('click', clearAll);
  initFromURL();
  initDropdowns();
  renderGrid();
})();
</script>


<style is:global>
  .filters { display: flex; flex-direction: column; gap: 16px; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .filters__row { display: flex; align-items: center; gap: 24px; flex-wrap: wrap; }
  .filters__label { font-size: 14px; color: rgba(255,255,255,0.5); }
  .filters__count { margin-left: auto; font-size: 14px; color: rgba(255,255,255,0.4); }
  .filters__tags { display: none; align-items: center; gap: 8px; flex-wrap: wrap; }

  .dropdown { position: relative; }
  .dropdown__trigger { display: inline-flex; align-items: center; gap: 6px; padding: 0; font-size: 14px; font-family: inherit; color: rgba(255,255,255,0.6); background: none; border: none; cursor: pointer; }
  .dropdown__trigger:hover { color: white; }
  .dropdown__badge { display: none; min-width: 18px; height: 18px; padding: 0 5px; font-size: 11px; font-weight: 600; color: white; background: #6366f1; border-radius: 9px; align-items: center; justify-content: center; }
  .dropdown__arrow { opacity: 0.5; transition: transform 0.2s; }
  .dropdown.is-open .dropdown__arrow { transform: rotate(180deg); }
  .dropdown__menu { position: absolute; top: calc(100% + 8px); left: 0; min-width: 200px; padding: 8px 0; background: #1f2128; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); opacity: 0; visibility: hidden; transform: translateY(-8px); transition: all 0.2s; z-index: 100; }
  .dropdown.is-open .dropdown__menu { opacity: 1; visibility: visible; transform: translateY(0); }
  .dropdown__option { display: flex; align-items: center; gap: 10px; padding: 10px 16px; cursor: pointer; }
  .dropdown__option:hover { background: rgba(255,255,255,0.05); }
  .dropdown__checkbox { width: 16px; height: 16px; accent-color: #6366f1; cursor: pointer; }
  .dropdown__text { flex: 1; font-size: 14px; color: rgba(255,255,255,0.8); }
  .dropdown__count { font-size: 13px; color: rgba(255,255,255,0.4); }

  .active-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; font-size: 13px; font-family: inherit; color: white; background: transparent; border: 1px solid rgba(255,255,255,0.2); border-radius: 100px; cursor: pointer; }
  .active-tag:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.3); }
  .active-tag__x { font-size: 15px; opacity: 0.5; }
  .clear-all-btn { padding: 6px 0; font-size: 13px; font-family: inherit; color: rgba(255,255,255,0.5); background: none; border: none; cursor: pointer; text-decoration: underline; margin-left: 8px; }
  .clear-all-btn:hover { color: white; }

  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  
  .card { display: flex; flex-direction: column; text-decoration: none; color: inherit; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; overflow: hidden; transition: all 0.25s; }
  .card:hover { transform: translateY(-6px); border-color: rgba(255,255,255,0.12); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
  
  .card__preview { position: relative; aspect-ratio: 16 / 9; background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(236,72,153,0.08)); overflow: hidden; }
  .card__img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
  .card:hover .card__img { transform: scale(1.08); }
  
  .card__placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(236,72,153,0.08)); }
  .card__initial { font-size: 56px; font-weight: 700; color: rgba(255,255,255,0.15); text-transform: uppercase; }
  
  .card__overlay { position: absolute; top: 0; left: 0; right: 0; display: flex; justify-content: space-between; align-items: flex-start; padding: 12px; }
  .card__rating { padding: 5px 10px; font-size: 13px; font-weight: 600; color: #fbbf24; background: rgba(0,0,0,0.7); border-radius: 8px; }
  .card__badge { padding: 5px 8px; font-size: 14px; background: rgba(0,0,0,0.7); border-radius: 8px; }
  
  .card__body { padding: 16px; display: flex; flex-direction: column; gap: 8px; }
  .card__header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
  .card__title { margin: 0; font-size: 17px; font-weight: 600; color: white; line-height: 1.3; }
  .card__price { flex-shrink: 0; font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.5); white-space: nowrap; }
  .card__price--free { color: #34d399; font-weight: 600; }
  
  .card__desc { margin: 0; font-size: 14px; color: rgba(255,255,255,0.5); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  
  .card__tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
  .tag { padding: 4px 10px; font-size: 11px; font-weight: 500; color: rgba(255,255,255,0.65); background: rgba(255,255,255,0.06); border-radius: 6px; }
  .card:hover .tag { background: rgba(255,255,255,0.1); }
  .tag--nsfw { color: #f87171; background: rgba(248,113,113,0.12); }
  .tag--free { color: #34d399; background: rgba(52,211,153,0.12); }
  .tag--ru { color: #60a5fa; background: rgba(96,165,250,0.12); }

  .catalog-empty { display: none; text-align: center; padding: 80px 20px; color: rgba(255,255,255,0.6); }
  .catalog-empty p { margin: 0 0 20px; font-size: 16px; }
  .catalog-empty button { padding: 10px 20px; font-size: 14px; font-family: inherit; color: white; background: #6366f1; border: none; border-radius: 8px; cursor: pointer; }
  .catalog-actions { text-align: center; padding: 32px 0; border-top: 1px solid rgba(255,255,255,0.08); }
  .action-link { font-size: 16px; font-weight: 500; color: #6366f1; text-decoration: none; }
  .action-link:hover { text-decoration: underline; }

  @media (max-width: 768px) {
    .filters__row { gap: 12px; }
    .filters__label { display: none; }
    .filters__count { font-size: 12px; }
    .dropdown__trigger { font-size: 13px; }
    .grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .card { border-radius: 12px; }
    .card__body { padding: 12px; gap: 6px; }
    .card__header { flex-direction: column; gap: 4px; }
    .card__title { font-size: 14px; }
    .card__price { font-size: 12px; }
    .card__desc { display: none; }
    .card__overlay { padding: 8px; }
    .card__rating { padding: 4px 8px; font-size: 11px; }
    .active-tag { padding: 4px 10px; font-size: 12px; }
    .catalog-actions { padding: 24px 0; }
    .action-link { font-size: 14px; }
  }
  @media (max-width: 480px) { 
    .filters { padding: 12px 0; gap: 12px; }
    .filters__row { gap: 8px; }
    .dropdown__trigger { font-size: 12px; gap: 4px; }
    .dropdown__badge { min-width: 16px; height: 16px; font-size: 10px; }
    .grid { gap: 8px; } 
    .card__body { padding: 10px; } 
    .card__initial { font-size: 32px; }
    .card__title { font-size: 13px; }
    .tag { padding: 3px 6px; font-size: 10px; }
    .catalog-empty { padding: 40px 16px; }
    .catalog-empty p { font-size: 14px; }
    .catalog-empty button { padding: 8px 16px; font-size: 13px; }
  }
  @media (max-width: 360px) {
    .grid { grid-template-columns: 1fr; gap: 10px; }
    .card__desc { display: block; -webkit-line-clamp: 1; }
  }
</style>
