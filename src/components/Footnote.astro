---
/**
 * Контейнер сноски
 * Содержимое отображается во всплывающем окне при клике на FootnoteLink
 */
interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<ids-footnote class={className}>
  <slot />
</ids-footnote>

<script>
  // Footnote Store - singleton для управления состоянием
  class FootnoteStoreClass {
    #linkRegistry: Element[] = [];
    #noteRegistry: Element[] = [];
    #currentIndex: number | null = null;
    #subscribers = new Set<() => void>();

    registerLink(element: Element) {
      this.#linkRegistry.push(element);
      this.#notify();
    }

    unregisterLink(element: Element) {
      const index = this.#linkRegistry.indexOf(element);
      if (index > -1) {
        this.#linkRegistry.splice(index, 1);
        if (this.#currentIndex === index) {
          this.#currentIndex = null;
        } else if (this.#currentIndex !== null && this.#currentIndex > index) {
          this.#currentIndex--;
        }
        this.#notify();
      }
    }

    getLinkIndex(element: Element) {
      return this.#linkRegistry.indexOf(element);
    }

    registerNote(element: Element) {
      this.#noteRegistry.push(element);
      this.#notify();
    }

    unregisterNote(element: Element) {
      const index = this.#noteRegistry.indexOf(element);
      if (index > -1) {
        this.#noteRegistry.splice(index, 1);
        this.#notify();
      }
    }

    getNoteIndex(element: Element) {
      return this.#noteRegistry.indexOf(element);
    }

    get currentIndex() {
      return this.#currentIndex;
    }

    set currentIndex(value: number | null) {
      if (this.#currentIndex !== value) {
        this.#currentIndex = value;
        this.#notify();
      }
    }

    get linkRegistry() {
      return [...this.#linkRegistry];
    }

    get noteRegistry() {
      return [...this.#noteRegistry];
    }

    subscribe(callback: () => void) {
      this.#subscribers.add(callback);
    }

    unsubscribe(callback: () => void) {
      this.#subscribers.delete(callback);
    }

    #notify() {
      this.#subscribers.forEach((callback) => {
        try {
          callback();
        } catch (error) {
          console.error('FootnoteStore subscriber error:', error);
        }
      });
    }
  }

  const FootnoteStore = new FootnoteStoreClass();
  (window as any).FootnoteStore = FootnoteStore;

  function getFootnoteSymbol(index: number) {
    return (index + 1).toString();
  }

  class IdsFootnoteLink extends HTMLElement {
    #button: HTMLButtonElement | null = null;
    #label: HTMLLabelElement | null = null;

    connectedCallback() {
      this.#label = document.createElement('label');
      this.#button = document.createElement('button');
      this.#button.className = 'ids-footnote-link__button';

      while (this.firstChild) {
        this.#label.appendChild(this.firstChild);
      }

      this.#label.appendChild(this.#button);
      this.appendChild(this.#label);

      FootnoteStore.registerLink(this);
      this.#button.addEventListener('click', this.#handleClick);
      FootnoteStore.subscribe(this.#update);
      this.#update();
    }

    disconnectedCallback() {
      FootnoteStore.unregisterLink(this);
      FootnoteStore.unsubscribe(this.#update);
      this.#button?.removeEventListener('click', this.#handleClick);
    }

    #handleClick = (e: Event) => {
      e.preventDefault();
      e.stopPropagation();
      this.toggle();
    };

    #update = () => {
      const index = FootnoteStore.getLinkIndex(this);
      const isOpen = FootnoteStore.currentIndex === index;
      const symbol = getFootnoteSymbol(index);

      if (this.#button) {
        this.#button.textContent = symbol;
        this.#button.setAttribute('aria-expanded', String(isOpen));
        this.#button.setAttribute('aria-controls', `ids-footnote-${index}`);
        this.#button.classList.toggle('open', isOpen);
        this.#button.classList.toggle('enlarge', index >= 10);
      }
    };

    get index() {
      return FootnoteStore.getLinkIndex(this);
    }

    toggle() {
      const index = this.index;
      FootnoteStore.currentIndex = FootnoteStore.currentIndex === index ? null : index;
    }
  }

  class IdsFootnote extends HTMLElement {
    #wrapper: HTMLDivElement | null = null;
    #aside: HTMLElement | null = null;
    #closeButton: HTMLButtonElement | null = null;
    #resizeObserver: ResizeObserver | null = null;

    connectedCallback() {
      this.#wrapper = document.createElement('div');
      this.#wrapper.className = 'ids-footnote-wrap';

      while (this.firstChild) {
        this.#wrapper.appendChild(this.firstChild);
      }

      this.appendChild(this.#wrapper);
      FootnoteStore.registerNote(this.#wrapper);
      FootnoteStore.subscribe(this.#update);
      this.#update();
    }

    disconnectedCallback() {
      if (this.#wrapper) {
        FootnoteStore.unregisterNote(this.#wrapper);
      }
      FootnoteStore.unsubscribe(this.#update);
      this.#cleanup();
    }

    #update = () => {
      if (!this.#wrapper) return;
      const index = FootnoteStore.getNoteIndex(this.#wrapper);
      const isOpen = FootnoteStore.currentIndex === index;

      if (isOpen && !this.#aside) {
        this.#render(index);
        requestAnimationFrame(() => {
          if (this.#aside) {
            this.#updatePosition(index);
            this.#checkScrollability();
          }
        });
      } else if (!isOpen && this.#aside) {
        this.#cleanup();
      } else if (isOpen) {
        this.#updatePosition(index);
        this.#checkScrollability();
      }
    };

    #render(index: number) {
      if (!this.#wrapper) return;
      
      const scrollX = window.scrollX;
      const scrollY = window.scrollY;

      this.#aside = document.createElement('aside');
      this.#aside.className = 'ids-footnote';
      this.#aside.id = `ids-footnote-${index}`;
      this.#aside.setAttribute('role', 'dialog');

      const tempContent: Node[] = [];
      this.#wrapper.childNodes.forEach((node) => {
        if (node !== this.#aside) {
          tempContent.push(node.cloneNode(true));
        }
      });

      tempContent.forEach((node) => this.#aside!.appendChild(node));

      this.#closeButton = this.#createCloseButton();
      this.#aside.appendChild(this.#closeButton);
      this.#wrapper.appendChild(this.#aside);

      window.scrollTo(scrollX, scrollY);

      this.#addFirstParagraphBadge(index);
      this.#setupEventListeners();

      this.#resizeObserver = new ResizeObserver(() => this.#checkScrollability());
      this.#resizeObserver.observe(this.#aside);
    }

    #cleanup() {
      if (this.#aside) {
        this.#removeEventListeners();
        this.#resizeObserver?.disconnect();
        this.#aside.remove();
        this.#aside = null;
        this.#closeButton = null;
        document.documentElement.style.removeProperty('overflow');
      }
    }

    #updatePosition(index: number) {
      const linkElement = FootnoteStore.linkRegistry[index];
      if (!linkElement || !this.#wrapper) return;

      this.#wrapper.style.setProperty('--top', '0px');
      void this.#wrapper.offsetHeight;

      const linkRect = linkElement.getBoundingClientRect();
      const wrapperRect = this.#wrapper.getBoundingClientRect();
      const offsetTop = `${linkRect.top - wrapperRect.top}px`;

      this.#wrapper.style.setProperty('--top', offsetTop);
    }

    #checkScrollability() {
      if (!this.#aside) return;

      const isScrollable = this.#aside.scrollHeight > this.#aside.clientHeight;
      this.#aside.classList.toggle('scrollable', isScrollable);

      if (isScrollable) {
        document.documentElement.style.overflow = 'hidden';
      } else {
        document.documentElement.style.removeProperty('overflow');
      }
    }

    #addFirstParagraphBadge(index: number) {
      const firstP = this.#aside?.querySelector('p:first-child');
      if (firstP) {
        firstP.setAttribute('data-index', getFootnoteSymbol(index));
      }
      if (index >= 10) {
        this.#aside?.classList.add('enlarge-number');
      }
    }

    #setupEventListeners() {
      document.addEventListener('click', this.#handleOutsideClick, true);
      document.addEventListener('keyup', this.#handleEscape);
      this.#closeButton?.addEventListener('click', this.#handleCloseClick);
    }

    #removeEventListeners() {
      document.removeEventListener('click', this.#handleOutsideClick, true);
      document.removeEventListener('keyup', this.#handleEscape);
      this.#closeButton?.removeEventListener('click', this.#handleCloseClick);
    }

    #handleOutsideClick = (e: Event) => {
      const targetNode = e.target as Node;
      if (this.#aside?.contains(targetNode)) return;

      const clickedLink = FootnoteStore.linkRegistry.some((link) => link.contains(targetNode));
      if (clickedLink) return;

      e.preventDefault();
      e.stopPropagation();
      this.close();
    };

    #handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        this.close();
      }
    };

    #handleCloseClick = () => {
      this.close();
    };

    #createCloseButton() {
      const button = document.createElement('button');
      button.className = 'ids-footnote__close';

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('viewBox', '0 0 20 20');

      const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line1.setAttribute('x1', '0');
      line1.setAttribute('y1', '20');
      line1.setAttribute('x2', '20');
      line1.setAttribute('y2', '0');

      const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line2.setAttribute('x1', '0');
      line2.setAttribute('y1', '0');
      line2.setAttribute('x2', '20');
      line2.setAttribute('y2', '20');

      svg.appendChild(line1);
      svg.appendChild(line2);

      const span = document.createElement('span');
      span.textContent = 'Закрыть';

      button.appendChild(svg);
      button.appendChild(span);

      return button;
    }

    close() {
      if (!this.#wrapper) return;
      const index = FootnoteStore.getNoteIndex(this.#wrapper);
      if (FootnoteStore.currentIndex === index) {
        FootnoteStore.currentIndex = null;
      }
    }
  }

  if (!customElements.get('ids-footnote-link')) {
    customElements.define('ids-footnote-link', IdsFootnoteLink);
  }
  if (!customElements.get('ids-footnote')) {
    customElements.define('ids-footnote', IdsFootnote);
  }
</script>
